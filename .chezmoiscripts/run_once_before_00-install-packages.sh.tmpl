#!/usr/bin/env bash
set -euo pipefail

echo "==> Installing system packages..."

{{ if eq .pkgmgr "apt" -}}
sudo apt update
sudo apt install -y \
    zsh \
    tmux \
    git \
    curl \
    wget \
    jq \
    tree \
    htop \
    ripgrep \
    fd-find \
    bat \
    zoxide \
    unzip \
    shellcheck \
    stow \
    gpg \
    fuse

# Create symlinks for fd and bat (Debian/Ubuntu use different names)
if [[ -f /usr/bin/fdfind ]] && [[ ! -f ~/.local/bin/fd ]]; then
    mkdir -p ~/.local/bin
    ln -sf /usr/bin/fdfind ~/.local/bin/fd
fi
if [[ -f /usr/bin/batcat ]] && [[ ! -f ~/.local/bin/bat ]]; then
    mkdir -p ~/.local/bin
    ln -sf /usr/bin/batcat ~/.local/bin/bat
fi

{{ else if eq .pkgmgr "brew" -}}
# Install Homebrew if not present
if ! command -v brew &>/dev/null; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

brew bundle --no-lock --file=/dev/stdin <<EOF
brew "zsh"
brew "tmux"
brew "git"
brew "curl"
brew "wget"
brew "jq"
brew "tree"
brew "htop"
brew "ripgrep"
brew "fd"
brew "bat"
brew "fzf"
brew "zoxide"
brew "shellcheck"
brew "neovim"
brew "lazygit"
brew "yazi"
brew "stow"
EOF

{{ else if eq .pkgmgr "pacman" -}}
sudo pacman -Syu --noconfirm --needed \
    zsh \
    tmux \
    git \
    curl \
    wget \
    jq \
    tree \
    htop \
    ripgrep \
    fd \
    bat \
    fzf \
    zoxide \
    unzip \
    shellcheck \
    neovim \
    lazygit \
    yazi \
    stow \
    fuse2

{{ else if eq .pkgmgr "dnf" -}}
# Detect if we're on Amazon Linux
IS_AMAZON_LINUX=false
if grep -q "Amazon Linux" /etc/os-release 2>/dev/null; then
    IS_AMAZON_LINUX=true
fi

# Install base packages available on all dnf systems
sudo dnf install -y \
    zsh \
    tmux \
    git \
    curl \
    wget \
    jq \
    tree \
    htop \
    unzip \
    fuse \
    tar \
    gzip

if [[ "$IS_AMAZON_LINUX" == "true" ]]; then
    echo "==> Amazon Linux detected, installing tools from alternative sources..."
    mkdir -p ~/.local/bin

    # Install ripgrep from GitHub releases
    if ! command -v rg &>/dev/null; then
        echo "Installing ripgrep..."
        RG_VERSION=$(curl -sL "https://api.github.com/repos/BurntSushi/ripgrep/releases/latest" | jq -r '.tag_name')
        curl -sL "https://github.com/BurntSushi/ripgrep/releases/download/${RG_VERSION}/ripgrep-${RG_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
        cp /tmp/ripgrep-${RG_VERSION}-x86_64-unknown-linux-musl/rg ~/.local/bin/
        rm -rf /tmp/ripgrep-${RG_VERSION}-x86_64-unknown-linux-musl
    fi

    # Install fd from GitHub releases
    if ! command -v fd &>/dev/null; then
        echo "Installing fd..."
        FD_VERSION=$(curl -sL "https://api.github.com/repos/sharkdp/fd/releases/latest" | jq -r '.tag_name')
        curl -sL "https://github.com/sharkdp/fd/releases/download/${FD_VERSION}/fd-${FD_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
        cp /tmp/fd-${FD_VERSION}-x86_64-unknown-linux-musl/fd ~/.local/bin/
        rm -rf /tmp/fd-${FD_VERSION}-x86_64-unknown-linux-musl
    fi

    # Install bat from GitHub releases
    if ! command -v bat &>/dev/null; then
        echo "Installing bat..."
        BAT_VERSION=$(curl -sL "https://api.github.com/repos/sharkdp/bat/releases/latest" | jq -r '.tag_name')
        curl -sL "https://github.com/sharkdp/bat/releases/download/${BAT_VERSION}/bat-${BAT_VERSION}-x86_64-unknown-linux-musl.tar.gz" | tar xz -C /tmp
        cp /tmp/bat-${BAT_VERSION}-x86_64-unknown-linux-musl/bat ~/.local/bin/
        rm -rf /tmp/bat-${BAT_VERSION}-x86_64-unknown-linux-musl
    fi

    # Install zoxide from GitHub releases
    if ! command -v zoxide &>/dev/null; then
        echo "Installing zoxide..."
        curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
    fi

    # Install shellcheck from GitHub releases
    if ! command -v shellcheck &>/dev/null; then
        echo "Installing shellcheck..."
        SC_VERSION=$(curl -sL "https://api.github.com/repos/koalaman/shellcheck/releases/latest" | jq -r '.tag_name')
        curl -sL "https://github.com/koalaman/shellcheck/releases/download/${SC_VERSION}/shellcheck-${SC_VERSION}.linux.x86_64.tar.xz" | tar xJ -C /tmp
        cp /tmp/shellcheck-${SC_VERSION}/shellcheck ~/.local/bin/
        rm -rf /tmp/shellcheck-${SC_VERSION}
    fi
else
    # Standard Fedora/RHEL with full package availability
    sudo dnf install -y \
        ripgrep \
        fd-find \
        bat \
        zoxide \
        ShellCheck
fi

{{ end -}}

# Set zsh as default shell if not already
if [[ "$SHELL" != *"zsh"* ]]; then
    echo "==> Setting zsh as default shell..."
    chsh -s "$(which zsh)" || true
fi

echo "==> Package installation complete"
